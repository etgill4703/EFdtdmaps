
<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Door-To-Door Interactive Map (NM-only) — Canonical</title>
  <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'>
  <link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css'>
  <link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css'>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #toolbar { position: absolute; z-index: 1000; top: 10px; left: 10px; right: 10px; display: grid; grid-template-columns: 1fr auto auto; gap: 8px; }
    .panel { background: rgba(255,255,255,0.95); border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 10px; }
    .panel label { font-size: 14px; font-weight: 600; }
    .search-input { flex: 1; min-width: 220px; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 14px; }
    .chip { padding: 6px 10px; border-radius: 20px; color: #fff; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
    .legend { position:absolute; bottom:10px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:13px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .legend-item { display:flex; align-items:center; gap:6px; margin:4px 0; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
    #status { position:absolute; top:10px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font: 13px/1.3 Segoe UI,Arial; max-width: 40vw; }
    #error { position:absolute; top:60px; right:10px; background:#ffecec; color:#b00020; border:1px solid #ffb4b4; border-radius:6px; padding:10px 12px; font: 13px/1.3 Segoe UI,Arial; max-width: 40vw; display:none; }
    @media (max-width: 840px){ #toolbar{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id='toolbar'>
    <div class='panel'>
      <label for='search'>Search:</label>
      <input id='search' class='search-input' type='text' placeholder='Prospect, address, sales rep or result...' />
    </div>
    <div class='panel' id='viewPanel'>
      <label>View:</label>
      <label><input type='radio' name='view' value='cluster' checked> Cluster markers</label>
      <label><input type='radio' name='view' value='dots'> Show dots</label>
      <label><input type='checkbox' id='heatToggle'> Show heatmap (All results)</label>
    </div>
    <div class='panel'>
      <div>
        <label for='rep'>Rep selector:</label>
        <select id='rep'><option value='*'>All reps</option></select>
      </div>
      <div>
        <label>Status filter:</label>
        <label class='chip' style='background:#666'><input type='radio' name='status' value='*' checked> All</label>
        <label class='chip' style='background:#2e7d32'><input type='radio' name='status' value='Sold'> Sold</label>
        <label class='chip' style='background:#757575'><input type='radio' name='status' value='Not Sold'> Not Sold</label>
      </div>
    </div>
  </div>

  <div id='map'></div>
  <div id='status'>Filtered to New Mexico bounds: lat 31.33–37.0, lng -109.06–-103.0.</div>
  <div id='error'>Map libraries failed to load. Your network may block CDNs. Try another browser/network or ask IT to allow unpkg.com and tile servers.</div>

  <div class='legend'>
    <div><strong>Legend:</strong></div>
    <div class='legend-item'><span class='dot' style='background:#2e7d32;'></span> Sold</div>
    <div class='legend-item'><span class='dot' style='background:#757575;'></span> Not Sold (all statuses not exactly "Sold")</div>
  </div>

  <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
  <script>
    // Load supporting libraries with fallback
    function loadScript(srcs, onload){
      (function tryLoad(i){
        var s=document.createElement('script'); s.src=srcs[i];
        s.onload=onload;
        s.onerror=function(){ if(i+1<srcs.length) tryLoad(i+1); else document.getElementById('error').style.display='block'; };
        document.head.appendChild(s);
      })(0);
    }
    loadScript([
      'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js',
      'https://unpkg.com/papaparse@5.4.1/papaparse.min.js'
    ], function(){
      loadScript([
        'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'
      ], function(){
        loadScript([
          'https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js'
        ], start);
      });
    });

    const NM = { minLat:31.33, maxLat:37.0, minLon:-109.06, maxLon:-103.0 };
    const STATUS_COLORS = { 'Sold':'#2e7d32', 'Not Sold':'#757575' };

    function normalizeHeader(h){
      const zwnbsp='\ufeff';
      let x=String(h||'').replace(new RegExp(zwnbsp,'g'),'').trim().toLowerCase();
      if(['appointment date','date','appt date'].includes(x)) return 'date';
      if(['address','street'].includes(x)) return 'address';
      if(['prospect: prospect name','prospect','customer','name'].includes(x)) return 'prospect';
      if(['sold price','amount','revenue','price'].includes(x)) return 'price';
      if(['latitude','lat'].includes(x)) return 'lat';
      if(['longitude','lon','lng'].includes(x)) return 'lon';
      if(['sales rep 1: staff name','sales rep','rep','owner'].includes(x)) return 'rep';
      if(['result','status','result detail'].includes(x)) return 'result';
      return x;
    }

    function toNum(v){ if(v==null) return null; const s=String(v); const s2=s.replace(/[^0-9.+-]/g,''); const n=Number.parseFloat(s2); return Number.isFinite(n)?n:null; }

    function normalizeRow(row){
      const rec={}; for(const k in row) rec[normalizeHeader(k)] = row[k];
      const lat=toNum(rec.lat); let lon=toNum(rec.lon); if(lon!=null) lon = -Math.abs(lon);
      const inNM = (lat!=null && lon!=null && lat>=NM.minLat && lat<=NM.maxLat && lon>=NM.minLon && lon<=NM.maxLon);
      const priceNum=toNum(rec.price); const priceFmt=priceNum!=null? priceNum.toLocaleString(undefined,{style:'currency',currency:'USD'}) : '';
      let dateStr=''; if(rec.date){ const d=new Date(rec.date); if(!isNaN(d)){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); dateStr=`${y}-${m}-${da}`; }}
      const resultRaw=String(rec.result||'').trim();
      const statusNorm = (resultRaw==='Sold') ? 'Sold' : 'Not Sold';
      return { lat, lon, inNM, prospect:String(rec.prospect||''), address:String(rec.address||''), rep:String(rec.rep||''), result:resultRaw, status:statusNorm, price:priceFmt, date:dateStr };
    }

    let allRecords=[];
    let map, clusterLayer, dotsLayer, heatLayer;

    function start(){
      const statusEl=document.getElementById('status');
      Papa.parse('data.csv?v='+Date.now(), {
        download:true, header:true, skipEmptyLines:true,
        error: function(err){ document.getElementById('error').style.display='block'; statusEl.textContent='Failed to load data.csv'; console.error(err); },
        complete: function(res){
          const rows = res.data||[];
          allRecords = rows.map(normalizeRow).filter(r=>r.inNM);
          statusEl.textContent = `Filtered to New Mexico bounds: lat ${NM.minLat}–${NM.maxLat}, lng ${NM.minLon}–${NM.maxLon}. ${allRecords.length.toLocaleString()} records in view.`;
          buildMap(); buildControls(); render();
        }
      });
    }

    function buildMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      const southWest = L.latLng(NM.minLat, NM.minLon), northEast = L.latLng(NM.maxLat, NM.maxLon);
      const bounds = L.latLngBounds(southWest, northEast);
      map.fitBounds(bounds, {padding:[20,20]});
      map.setMaxBounds(bounds.pad(0.1));
      clusterLayer = L.markerClusterGroup({ showCoverageOnHover:false, disableClusteringAtZoom: 15 });
      dotsLayer = L.layerGroup();
      heatLayer = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 17 });
      heatLayer.addTo(map);
      map.addLayer(clusterLayer);
      map.addLayer(dotsLayer);
    }

    function popupHtml(d){
      const apple = `https://maps.apple.com/?q=${encodeURIComponent(d.address)}&ll=${d.lat},${d.lon}`;
      const google = `https://www.google.com/maps/search/?api=1&query=${d.lat},${d.lon}`;
      return `
        <div style="font-family:Segoe UI, Arial; min-width:240px">
          <div style="font-size:15px; font-weight:700;">${d.prospect || 'Prospect'}</div>
          <div style="margin-top:4px;">${d.address || ''}</div>
          <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:10px;">
            <span><strong>Date:</strong> ${d.date || ''}</span>
            <span><strong>Rep:</strong> ${d.rep || ''}</span>
            <span><strong>Status:</strong> ${d.status} ${d.result && d.result!=='Sold' ? `(${d.result})` : ''}</span>
            <span><strong>Price:</strong> ${d.price || ''}</span>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <a href="${apple}" target="_blank" rel="noopener">Apple Maps</a>
            <a href="${google}" target="_blank" rel="noopener">Google Maps</a>
          </div>
        </div>`;
    }

    function currentFilters(){
      const repSel = document.getElementById('rep').value;
      const statusSel = document.querySelector('input[name=status]:checked').value;
      const q = document.getElementById('search').value.trim().toLowerCase();
      return { repSel, statusSel, q };
    }

    function applyFilters(){
      const {repSel, statusSel, q} = currentFilters();
      return allRecords.filter(d=>{
        if (repSel!=='*' && d.rep!==repSel) return false;
        if (statusSel!=='*' && d.status!==statusSel) return false;
        if (q){
          const t = `${d.prospect} ${d.address} ${d.rep} ${d.result}`.toLowerCase();
          if (!t.includes(q)) return false;
        }
        return true;
      });
    }

    function render(){
      const records = applyFilters();
      const view = document.querySelector('input[name=view]:checked').value;
      // Clear layers
      clusterLayer.clearLayers();
      dotsLayer.clearLayers();
      heatLayer.setLatLngs([]);
      // Heatmap uses all in-NM points (unfiltered) if toggle checked
      const heatOn = document.getElementById('heatToggle').checked;
      if (heatOn){
        heatLayer.setLatLngs(allRecords.filter(r=>r.lat!=null && r.lon!=null).map(r=>[r.lat,r.lon]));
      }
      if (view==='cluster'){
        records.forEach(d=>{
          const color = STATUS_COLORS[d.status] || '#1976d2';
          const m = L.circleMarker([d.lat,d.lon], { radius:8, color:'#333', weight:1, fillColor:color, fillOpacity:0.9 });
          m.bindPopup(popupHtml(d));
          clusterLayer.addLayer(m);
        });
      } else {
        records.forEach(d=>{
          const color = STATUS_COLORS[d.status] || '#1976d2';
          const m = L.circleMarker([d.lat,d.lon], { radius:8, color:'#333', weight:1, fillColor:color, fillOpacity:0.9 });
          m.bindPopup(popupHtml(d));
          m.addTo(dotsLayer);
        });
      }
    }

    function buildControls(){
      // Populate rep dropdown
      const reps = Array.from(new Set(allRecords.map(r=>r.rep || '(Unknown)'))).sort((a,b)=>a.localeCompare(b));
      const repSel = document.getElementById('rep');
      reps.forEach(r=>{ const opt=document.createElement('option'); opt.value=r; opt.textContent=r; repSel.appendChild(opt); });
      // Wire events
      document.getElementById('search').addEventListener('input', render);
      repSel.addEventListener('change', render);
      document.querySelectorAll('input[name=status]').forEach(el=> el.addEventListener('change', render));
      document.querySelectorAll('input[name=view]').forEach(el=> el.addEventListener('change', render));
      document.getElementById('heatToggle').addEventListener('change', render);
    }
  </script>
</body>
</html>
